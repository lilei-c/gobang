var ge=Object.defineProperty;var pe=(B,F,W)=>F in B?ge(B,F,{enumerable:!0,configurable:!0,writable:!0,value:W}):B[F]=W;var j=(B,F,W)=>(pe(B,typeof F!="symbol"?F+"":F,W),W);(function(){"use strict";const it={l1:1,d2:8,l2:64,d3:512,l3:4096,d4:16384,l4:65536,l5:262144},z=s=>({l1:s&7,d2:s>>3&7,l2:s>>6&7,d3:s>>9&7,l3:s>>12&3,d4:s>>14&3,l4:s>>16&3,l5:s>>18&3});console.log("getPointMode");const k={l1:1,d2:2,l2:8,d3:12,l3:30,d4:50,l4:500,l5:1e4};console.log("getPoinScoretMode");const rt=s=>{const{l5:t,l4:e,d4:n,l3:r,d3:a,l2:f,d2:u,l1:i}=s;let l=0;return t&&(l+=k.l5*t),e&&(l+=k.l4*e),n&&(l+=k.d4*n),r&&(l+=k.l3*r),a&&(l+=k.d3*a),f&&(l+=k.l2*f),u&&(l+=k.d2*u),i&&(l+=k.l1*i),l};console.log("calcEvaPointScore"),console.warn("todo: 测试 countLine 是否正确");const ot=(s,t,e)=>n=>{let r=1;for(let a=0;a<4;a++){const f=n[a];r<<=1,f===s?r|=1:(f===t||f===e)&&(r=1)}r=r<<1|1;for(let a=5;a<9;a++){const f=n[a];if(f===t||f===e)break;r<<=1,f===s&&(r|=1)}return r};console.log("countLine");const Y=(s=>Array.from({length:1<<s+1},(t,e)=>`0b${e.toString(2)}`))(12);console.log(Y.length),Y.forEach(s=>null);const st=[],yt={l1:s=>/010/.test(s)&&s.length>5,d2:s=>/10{0,1}1/.test(s)&&s.length>=5,l2:s=>[/000110/,/001100/,/011000/,/001010/,/010100/].some(t=>t.test(s)),d3:s=>[/111/,/1011/,/1101/,/11001/,/10011/,/10101/].some(t=>t.test(s))&&s.length>=5,l3:s=>[/010110/,/011010/,/01110/,/1010101/].some(t=>t.test(s)),d4:s=>[/11110/,/01111/,/11011/,/11101/,/10111/].some(t=>t.test(s)),l4:s=>[/011110/,/1011101/,/11011011/,/111010111/].some(t=>t.test(s)),l5:s=>/1{5}/.test(s)};for(const[s,t]of Object.entries(yt))Y.forEach(e=>{t(e.slice(3))&&(st[+e]=it[s])});console.log("allModes.forEach");const O=(s,t)=>typeof t=="object"?Array(s).fill().map(()=>structuredClone(t)):Array(s).fill(t),at=s=>new Promise(t=>setTimeout(t,s));var G=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function wt(s){if(s.__esModule)return s;var t=s.default;if(typeof t=="function"){var e=function n(){if(this instanceof n){var r=[null];r.push.apply(r,arguments);var a=Function.bind.apply(t,r);return new a}return t.apply(this,arguments)};e.prototype=t.prototype}else e={};return Object.defineProperty(e,"__esModule",{value:!0}),Object.keys(s).forEach(function(n){var r=Object.getOwnPropertyDescriptor(s,n);Object.defineProperty(e,n,r.get?r:{enumerable:!0,get:function(){return s[n]}})}),e}var V={},Mt={get exports(){return V},set exports(s){V=s}};(function(s){(function(t,e,n){function r(i){var l=this,h=u();l.next=function(){var o=2091639*l.s0+l.c*23283064365386963e-26;return l.s0=l.s1,l.s1=l.s2,l.s2=o-(l.c=o|0)},l.c=1,l.s0=h(" "),l.s1=h(" "),l.s2=h(" "),l.s0-=h(i),l.s0<0&&(l.s0+=1),l.s1-=h(i),l.s1<0&&(l.s1+=1),l.s2-=h(i),l.s2<0&&(l.s2+=1),h=null}function a(i,l){return l.c=i.c,l.s0=i.s0,l.s1=i.s1,l.s2=i.s2,l}function f(i,l){var h=new r(i),o=l&&l.state,c=h.next;return c.int32=function(){return h.next()*4294967296|0},c.double=function(){return c()+(c()*2097152|0)*11102230246251565e-32},c.quick=c,o&&(typeof o=="object"&&a(o,h),c.state=function(){return a(h,{})}),c}function u(){var i=4022871197,l=function(h){h=String(h);for(var o=0;o<h.length;o++){i+=h.charCodeAt(o);var c=.02519603282416938*i;i=c>>>0,c-=i,c*=i,i=c>>>0,c-=i,i+=c*4294967296}return(i>>>0)*23283064365386963e-26};return l}e&&e.exports?e.exports=f:n&&n.amd?n(function(){return f}):this.alea=f})(G,s,!1)})(Mt);var K={},Lt={get exports(){return K},set exports(s){K=s}};(function(s){(function(t,e,n){function r(u){var i=this,l="";i.x=0,i.y=0,i.z=0,i.w=0,i.next=function(){var o=i.x^i.x<<11;return i.x=i.y,i.y=i.z,i.z=i.w,i.w^=i.w>>>19^o^o>>>8},u===(u|0)?i.x=u:l+=u;for(var h=0;h<l.length+64;h++)i.x^=l.charCodeAt(h)|0,i.next()}function a(u,i){return i.x=u.x,i.y=u.y,i.z=u.z,i.w=u.w,i}function f(u,i){var l=new r(u),h=i&&i.state,o=function(){return(l.next()>>>0)/4294967296};return o.double=function(){do var c=l.next()>>>11,d=(l.next()>>>0)/4294967296,g=(c+d)/(1<<21);while(g===0);return g},o.int32=l.next,o.quick=o,h&&(typeof h=="object"&&a(h,l),o.state=function(){return a(l,{})}),o}e&&e.exports?e.exports=f:n&&n.amd?n(function(){return f}):this.xor128=f})(G,s,!1)})(Lt);var Z={},Pt={get exports(){return Z},set exports(s){Z=s}};(function(s){(function(t,e,n){function r(u){var i=this,l="";i.next=function(){var o=i.x^i.x>>>2;return i.x=i.y,i.y=i.z,i.z=i.w,i.w=i.v,(i.d=i.d+362437|0)+(i.v=i.v^i.v<<4^(o^o<<1))|0},i.x=0,i.y=0,i.z=0,i.w=0,i.v=0,u===(u|0)?i.x=u:l+=u;for(var h=0;h<l.length+64;h++)i.x^=l.charCodeAt(h)|0,h==l.length&&(i.d=i.x<<10^i.x>>>4),i.next()}function a(u,i){return i.x=u.x,i.y=u.y,i.z=u.z,i.w=u.w,i.v=u.v,i.d=u.d,i}function f(u,i){var l=new r(u),h=i&&i.state,o=function(){return(l.next()>>>0)/4294967296};return o.double=function(){do var c=l.next()>>>11,d=(l.next()>>>0)/4294967296,g=(c+d)/(1<<21);while(g===0);return g},o.int32=l.next,o.quick=o,h&&(typeof h=="object"&&a(h,l),o.state=function(){return a(l,{})}),o}e&&e.exports?e.exports=f:n&&n.amd?n(function(){return f}):this.xorwow=f})(G,s,!1)})(Pt);var U={},St={get exports(){return U},set exports(s){U=s}};(function(s){(function(t,e,n){function r(u){var i=this;i.next=function(){var h=i.x,o=i.i,c,d;return c=h[o],c^=c>>>7,d=c^c<<24,c=h[o+1&7],d^=c^c>>>10,c=h[o+3&7],d^=c^c>>>3,c=h[o+4&7],d^=c^c<<7,c=h[o+7&7],c=c^c<<13,d^=c^c<<9,h[o]=d,i.i=o+1&7,d};function l(h,o){var c,d=[];if(o===(o|0))d[0]=o;else for(o=""+o,c=0;c<o.length;++c)d[c&7]=d[c&7]<<15^o.charCodeAt(c)+d[c+1&7]<<13;for(;d.length<8;)d.push(0);for(c=0;c<8&&d[c]===0;++c);for(c==8?d[7]=-1:d[c],h.x=d,h.i=0,c=256;c>0;--c)h.next()}l(i,u)}function a(u,i){return i.x=u.x.slice(),i.i=u.i,i}function f(u,i){u==null&&(u=+new Date);var l=new r(u),h=i&&i.state,o=function(){return(l.next()>>>0)/4294967296};return o.double=function(){do var c=l.next()>>>11,d=(l.next()>>>0)/4294967296,g=(c+d)/(1<<21);while(g===0);return g},o.int32=l.next,o.quick=o,h&&(h.x&&a(h,l),o.state=function(){return a(l,{})}),o}e&&e.exports?e.exports=f:n&&n.amd?n(function(){return f}):this.xorshift7=f})(G,s,!1)})(St);var Q={},kt={get exports(){return Q},set exports(s){Q=s}};(function(s){(function(t,e,n){function r(u){var i=this;i.next=function(){var h=i.w,o=i.X,c=i.i,d,g;return i.w=h=h+1640531527|0,g=o[c+34&127],d=o[c=c+1&127],g^=g<<13,d^=d<<17,g^=g>>>15,d^=d>>>12,g=o[c]=g^d,i.i=c,g+(h^h>>>16)|0};function l(h,o){var c,d,g,y,M,v=[],A=128;for(o===(o|0)?(d=o,o=null):(o=o+"\0",d=0,A=Math.max(A,o.length)),g=0,y=-32;y<A;++y)o&&(d^=o.charCodeAt((y+32)%o.length)),y===0&&(M=d),d^=d<<10,d^=d>>>15,d^=d<<4,d^=d>>>13,y>=0&&(M=M+1640531527|0,c=v[y&127]^=d+M,g=c==0?g+1:0);for(g>=128&&(v[(o&&o.length||0)&127]=-1),g=127,y=4*128;y>0;--y)d=v[g+34&127],c=v[g=g+1&127],d^=d<<13,c^=c<<17,d^=d>>>15,c^=c>>>12,v[g]=d^c;h.w=M,h.X=v,h.i=g}l(i,u)}function a(u,i){return i.i=u.i,i.w=u.w,i.X=u.X.slice(),i}function f(u,i){u==null&&(u=+new Date);var l=new r(u),h=i&&i.state,o=function(){return(l.next()>>>0)/4294967296};return o.double=function(){do var c=l.next()>>>11,d=(l.next()>>>0)/4294967296,g=(c+d)/(1<<21);while(g===0);return g},o.int32=l.next,o.quick=o,h&&(h.X&&a(h,l),o.state=function(){return a(l,{})}),o}e&&e.exports?e.exports=f:n&&n.amd?n(function(){return f}):this.xor4096=f})(G,s,!1)})(kt);var J={},_t={get exports(){return J},set exports(s){J=s}};(function(s){(function(t,e,n){function r(u){var i=this,l="";i.next=function(){var o=i.b,c=i.c,d=i.d,g=i.a;return o=o<<25^o>>>7^c,c=c-d|0,d=d<<24^d>>>8^g,g=g-o|0,i.b=o=o<<20^o>>>12^c,i.c=c=c-d|0,i.d=d<<16^c>>>16^g,i.a=g-o|0},i.a=0,i.b=0,i.c=-1640531527,i.d=1367130551,u===Math.floor(u)?(i.a=u/4294967296|0,i.b=u|0):l+=u;for(var h=0;h<l.length+20;h++)i.b^=l.charCodeAt(h)|0,i.next()}function a(u,i){return i.a=u.a,i.b=u.b,i.c=u.c,i.d=u.d,i}function f(u,i){var l=new r(u),h=i&&i.state,o=function(){return(l.next()>>>0)/4294967296};return o.double=function(){do var c=l.next()>>>11,d=(l.next()>>>0)/4294967296,g=(c+d)/(1<<21);while(g===0);return g},o.int32=l.next,o.quick=o,h&&(typeof h=="object"&&a(h,l),o.state=function(){return a(l,{})}),o}e&&e.exports?e.exports=f:n&&n.amd?n(function(){return f}):this.tychei=f})(G,s,!1)})(_t);var tt={},Nt={get exports(){return tt},set exports(s){tt=s}},Et={},Dt=Object.freeze({__proto__:null,default:Et}),At=wt(Dt);(function(s){(function(t,e,n){var r=256,a=6,f=52,u="random",i=n.pow(r,a),l=n.pow(2,f),h=l*2,o=r-1,c;function d(x,w,P){var L=[];w=w==!0?{entropy:!0}:w||{};var p=v(M(w.entropy?[x,E(e)]:x??A(),3),L),m=new g(L),b=function(){for(var S=m.g(a),C=i,N=0;S<l;)S=(S+N)*r,C*=r,N=m.g(1);for(;S>=h;)S/=2,C/=2,N>>>=1;return(S+N)/C};return b.int32=function(){return m.g(4)|0},b.quick=function(){return m.g(4)/4294967296},b.double=b,v(E(m.S),e),(w.pass||P||function(S,C,N,D){return D&&(D.S&&y(D,m),S.state=function(){return y(m,{})}),N?(n[u]=S,C):S})(b,p,"global"in w?w.global:this==n,w.state)}function g(x){var w,P=x.length,L=this,p=0,m=L.i=L.j=0,b=L.S=[];for(P||(x=[P++]);p<r;)b[p]=p++;for(p=0;p<r;p++)b[p]=b[m=o&m+x[p%P]+(w=b[p])],b[m]=w;(L.g=function(S){for(var C,N=0,D=L.i,X=L.j,H=L.S;S--;)C=H[D=o&D+1],N=N*r+H[o&(H[D]=H[X=o&X+C])+(H[X]=C)];return L.i=D,L.j=X,N})(r)}function y(x,w){return w.i=x.i,w.j=x.j,w.S=x.S.slice(),w}function M(x,w){var P=[],L=typeof x,p;if(w&&L=="object")for(p in x)try{P.push(M(x[p],w-1))}catch{}return P.length?P:L=="string"?x:x+"\0"}function v(x,w){for(var P=x+"",L,p=0;p<P.length;)w[o&p]=o&(L^=w[o&p]*19)+P.charCodeAt(p++);return E(w)}function A(){try{var x;return c&&(x=c.randomBytes)?x=x(r):(x=new Uint8Array(r),(t.crypto||t.msCrypto).getRandomValues(x)),E(x)}catch{var w=t.navigator,P=w&&w.plugins;return[+new Date,t,P,t.screen,E(e)]}}function E(x){return String.fromCharCode.apply(0,x)}if(v(n.random(),e),s.exports){s.exports=d;try{c=At}catch{}}else n["seed"+u]=d})(typeof self<"u"?self:G,[],Math)})(Nt);var Ct=V,Ot=K,Tt=Z,jt=U,Ft=Q,zt=J,$=tt;$.alea=Ct,$.xor128=Ot,$.xorwow=Tt,$.xorshift7=jt,$.xor4096=Ft,$.tychei=zt;var Xt=$;function lt(s,t){for(var e=0;e<t.length;e++){var n=t[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(s,$t(n.key),n)}}function et(s,t,e){return t&&lt(s.prototype,t),e&&lt(s,e),Object.defineProperty(s,"prototype",{writable:!1}),s}function ut(s,t){s.prototype=Object.create(t.prototype),s.prototype.constructor=s,nt(s,t)}function nt(s,t){return nt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(n,r){return n.__proto__=r,n},nt(s,t)}function Gt(s,t){if(typeof s!="object"||s===null)return s;var e=s[Symbol.toPrimitive];if(e!==void 0){var n=e.call(s,t||"default");if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(s)}function $t(s){var t=Gt(s,"string");return typeof t=="symbol"?t:String(t)}var I=function(){function s(){}var t=s.prototype;return t._seed=function(n,r){if(n===(n||0))return n;for(var a=""+n,f=0,u=0;u<a.length;++u)f^=a.charCodeAt(u)|0;return f},s}(),ct=function(s){ut(t,s);function t(n,r){var a;return a=s.call(this)||this,a._rng=void 0,a.seed(n,r),a}var e=t.prototype;return e.next=function(){return this._rng()},e.seed=function(r,a){this._rng=r},e.clone=function(r,a){return new t(this._rng,a)},et(t,[{key:"name",get:function(){return"function"}}]),t}(I),ht=function(){var s=[].slice.call(arguments),t=s,e=t[0],n=e===void 0?"default":e;switch(typeof n){case"object":if(n instanceof I)return n;break;case"function":return new ct(n);case"number":case"string":default:return new ct(Xt.apply(void 0,s))}throw new Error('invalid RNG "'+n+'"')},qt=function(s,t,e){return t===void 0&&(t=0),e===void 0&&(e=1),function(){return s.next()*(e-t)+t}};function T(s){return new Bt(s)}var Bt=function(t){var e=this;this.n=void 0,this.isInt=function(){if(Number.isInteger(e.n))return e;throw new Error("Expected number to be an integer, got "+e.n)},this.isPositive=function(){if(e.n>0)return e;throw new Error("Expected number to be positive, got "+e.n)},this.lessThan=function(n){if(e.n<n)return e;throw new Error("Expected number to be less than "+n+", got "+e.n)},this.greaterThanOrEqual=function(n){if(e.n>=n)return e;throw new Error("Expected number to be greater than or equal to "+n+", got "+e.n)},this.greaterThan=function(n){if(e.n>n)return e;throw new Error("Expected number to be greater than "+n+", got "+e.n)},this.n=t},Wt=function(s,t,e){return t===void 0&&(t=0),e===void 0&&(e=1),e===void 0&&(e=t===void 0?1:t,t=0),T(t).isInt(),T(e).isInt(),function(){return Math.floor(s.next()*(e-t+1)+t)}},Ht=function(s){return function(){return s.next()>=.5}},It=function(s,t,e){return t===void 0&&(t=0),e===void 0&&(e=1),function(){var n,r,a;do n=s.next()*2-1,r=s.next()*2-1,a=n*n+r*r;while(!a||a>1);return t+e*r*Math.sqrt(-2*Math.log(a)/a)}},Rt=function(s,t,e){t===void 0&&(t=0),e===void 0&&(e=1);var n=s.normal(t,e);return function(){return Math.exp(n())}},Yt=function(s,t){return t===void 0&&(t=.5),T(t).greaterThanOrEqual(0).lessThan(1),function(){return Math.floor(s.next()+t)}},Vt=function(s,t,e){return t===void 0&&(t=1),e===void 0&&(e=.5),T(t).isInt().isPositive(),T(e).greaterThanOrEqual(0).lessThan(1),function(){for(var n=0,r=0;n++<t;)s.next()<e&&r++;return r}},Kt=function(s,t){t===void 0&&(t=.5),T(t).greaterThan(0).lessThan(1);var e=1/Math.log(1-t);return function(){return Math.floor(1+Math.log(s.next())*e)}},Zt=[0,0,.6931471805599453,1.791759469228055,3.1780538303479458,4.787491742782046,6.579251212010101,8.525161361065415,10.60460290274525,12.801827480081469],Ut=function(t){return Zt[t]},Qt=.9189385332046727,Jt=function(s,t){if(t===void 0&&(t=1),T(t).isPositive(),t<10){var e=Math.exp(-t);return function(){for(var i=e,l=0,h=s.next();h>i;)h=h-i,i=t*i/++l;return l}}else{var n=Math.sqrt(t),r=.931+2.53*n,a=-.059+.02483*r,f=1.1239+1.1328/(r-3.4),u=.9277-3.6224/(r-2);return function(){for(;;){var i=void 0,l=s.next();if(l<=.86*u)return i=l/u-.43,Math.floor((2*a/(.5-Math.abs(i))+r)*i+t+.445);l>=u?i=s.next()-.5:(i=l/u-.93,i=(i<0?-.5:.5)-i,l=s.next()*u);var h=.5-Math.abs(i);if(!(h<.013&&l>h)){var o=Math.floor((2*a/h+r)*i+t+.445);if(l=l*f/(a/(h*h)+r),o>=10){var c=(o+.5)*Math.log(t/o)-t-Qt+o-(.08333333333333333-(.002777777777777778-1/(1260*o*o))/(o*o))/o;if(Math.log(l*n)<=c)return o}else if(o>=0){var d,g=(d=Ut(o))!=null?d:0;if(Math.log(l)<=o*Math.log(t)-t-g)return o}}}}}},te=function(s,t){return t===void 0&&(t=1),T(t).isPositive(),function(){return-Math.log(1-s.next())/t}},ee=function(s,t){return t===void 0&&(t=1),T(t).isInt().greaterThanOrEqual(0),function(){for(var e=0,n=0;n<t;++n)e+=s.next();return e}},ne=function(s,t){t===void 0&&(t=1),T(t).isInt().isPositive();var e=s.irwinHall(t);return function(){return e()/t}},ie=function(s,t){t===void 0&&(t=1),T(t).greaterThanOrEqual(0);var e=1/t;return function(){return 1/Math.pow(1-s.next(),e)}},re=function(s){ut(t,s);function t(){return s.apply(this,arguments)||this}var e=t.prototype;return e.next=function(){return Math.random()},e.seed=function(r,a){},e.clone=function(){return new t},et(t,[{key:"name",get:function(){return"default"}}]),t}(I),oe=function(){function s(e){var n=this;this._rng=void 0,this._patch=void 0,this._cache={},this.next=function(){return n._rng.next()},this.float=function(r,a){return n.uniform(r,a)()},this.int=function(r,a){return n.uniformInt(r,a)()},this.integer=function(r,a){return n.uniformInt(r,a)()},this.bool=function(){return n.uniformBoolean()()},this.boolean=function(){return n.uniformBoolean()()},this.uniform=function(r,a){return n._memoize("uniform",qt,r,a)},this.uniformInt=function(r,a){return n._memoize("uniformInt",Wt,r,a)},this.uniformBoolean=function(){return n._memoize("uniformBoolean",Ht)},this.normal=function(r,a){return It(n,r,a)},this.logNormal=function(r,a){return Rt(n,r,a)},this.bernoulli=function(r){return Yt(n,r)},this.binomial=function(r,a){return Vt(n,r,a)},this.geometric=function(r){return Kt(n,r)},this.poisson=function(r){return Jt(n,r)},this.exponential=function(r){return te(n,r)},this.irwinHall=function(r){return ee(n,r)},this.bates=function(r){return ne(n,r)},this.pareto=function(r){return ie(n,r)},e&&e instanceof I?this.use(e):this.use(new re),this._cache={}}var t=s.prototype;return t.clone=function(){var n=[].slice.call(arguments);return n.length?new s(ht.apply(void 0,n)):new s(this.rng.clone())},t.use=function(){this._rng=ht.apply(void 0,[].slice.call(arguments))},t.patch=function(){if(this._patch)throw new Error("Math.random already patched");this._patch=Math.random,Math.random=this.uniform()},t.unpatch=function(){this._patch&&(Math.random=this._patch,delete this._patch)},t.choice=function(n){if(!Array.isArray(n))throw new Error("Random.choice expected input to be an array, got "+typeof n);var r=n==null?void 0:n.length;if(r>0){var a=this.uniformInt(0,r-1)();return n[a]}else return},t._memoize=function(n,r){var a=[].slice.call(arguments,2),f=""+a.join(";"),u=this._cache[n];return(u===void 0||u.key!==f)&&(u={key:f,distribution:r.apply(void 0,[this].concat(a))},this._cache[n]=u),u.distribution},et(s,[{key:"rng",get:function(){return this._rng}}]),s}(),se=new oe;class ae{constructor({size:t,randFn:e}){e||(e=()=>se.int(0,2**31)),this.max=O(t).map(n=>O(t).map(e)),this.min=O(t).map(n=>O(t).map(e)),this.code=e(),this.hash={}}go(t,e,n){this.code^=n?this.max[t][e]:this.min[t][e]}get(){return this.hash[this.code]}set(t){this.hash[this.code]=t}resetHash(){this.hash={}}}const{l1:ft,d2:dt,l2:gt,d3:pt,l3:bt,d4:vt,l4:xt,l5:mt}=it;function le(s,t,e){let n=0,r=0,a=0,f=0,u=0,i=0,l=0,h=0,o=0,c=0,d=0,g=0,y=0,M=0,v=0,A=0;const E=(p,m)=>{if(m<34)return;const b=this.serialPointMode[m];if(b)if(p===1)switch(b){case ft:return h++;case dt:return l++;case gt:return i++;case pt:return u++;case bt:return f++;case vt:return a++;case xt:return r++;case mt:return n++;default:return console.error("error")}else switch(b){case ft:return A++;case dt:return v++;case gt:return M++;case pt:return y++;case bt:return g++;case vt:return d++;case xt:return c++;case mt:return o++;default:return console.error("error")}},x=(p,m,b)=>{if(b===0)return;let S=1,C=0,N=!1;for(let D=0;D<15;D++){const X=b&3;if(b>>=2,X===m||X===3){E(p,S),S=1,N=!0;continue}else if(X===0)if(C===0)C++,S<<=1;else{S<<=1,!(b&12)&&D!==14&&(S<<=1),E(p,S),S=4,!(b&12)&&D!==14&&(S<<=1),C=0,N=!0;continue}else C=0,N=!1,S=(S<<1)+1}N||E(p,S)};x(1,2,s[t]),x(2,1,s[t]),e&&(console.log({maxL1:h,maxD2:l,maxL2:i,maxD3:u,maxL3:f,maxD4:a,maxL4:r,maxL5:n}),console.log({minL1:A,minD2:v,minL2:M,minD3:y,minL3:g,minD4:d,minL4:c,minL5:o}));let w=0,P=0;return w=k.l5*n+k.l4*r+k.d4*a+k.l3*f+k.d3*u+k.l2*i+k.d2*l+k.l1*l,P=k.l5*o+k.l4*c+k.d4*d+k.l3*g+k.d3*y+k.l2*M+k.d2*v+k.l1*v,w-P}function ue(){let s=0;for(let t=0;t<4;t++)for(let e=0;e<this.scoreNode[t].length;e++){const n=this.scoreNode[t][e];n&&(s+=n)}return s}function ce(s,t,e){let n=[],r=[],a=[],f=[],u=[],i=[],l=[],h=[],o=[],c=[],d=[],g=[];for(let M=0;M<s.length;M++){const v=s[M],[A,E]=v;let x=0,w=0,P=z(this.maxPointsScore[A][E][0]);{const p=z(this.maxPointsScore[A][E][1]),m=z(this.maxPointsScore[A][E][2]),b=z(this.maxPointsScore[A][E][3]);P.l5+=p.l5+m.l5+b.l5,P.l4+=p.l4+m.l4+b.l4,P.d4+=p.d4+m.d4+b.d4,P.l3+=p.l3+m.l3+b.l3,P.d3+=p.d3+m.d3+b.d3,P.l2+=p.l2+m.l2+b.l2,P.d2+=p.d2+m.d2+b.d2,P.l1+=p.l1+m.l1+b.l1;const{l5:S,l4:C,d4:N,l3:D}=P;S?n.push(v):C?a.push(v):(N>1&&h.push(v),D&&N&&o.push(v),D>1&&d.push(v),D&&l.push(v),N&&u.push(v)),x=rt(P)}let L=z(this.minPointsScore[A][E][0]);{const p=z(this.minPointsScore[A][E][1]),m=z(this.minPointsScore[A][E][2]),b=z(this.minPointsScore[A][E][3]);L.l5+=p.l5+m.l5+b.l5,L.l4+=p.l4+m.l4+b.l4,L.d4+=p.d4+m.d4+b.d4,L.l3+=p.l3+m.l3+b.l3,L.d3+=p.d3+m.d3+b.d3,L.l2+=p.l2+m.l2+b.l2,L.d2+=p.d2+m.d2+b.d2,L.l1+=p.l1+m.l1+b.l1;const{l5:S,l4:C,d4:N,l3:D}=L;S?r.push(v):C?f.push(v):(D&&N&&c.push(v),N&&i.push(v)),w=rt(L)}g.push({position:[A,E],score:x*this.attackFactor+w*this.defenseFactor})}let y;if(e)return t?n.length?n:r.length?r:a.length?a:h.length?h:f.length||c.length?o.concat(u):o.concat(d).concat(u).concat(l):n.length?n:a.length||o.length?i.concat(a).concat(o).concat(u):g.sort((M,v)=>v.score-M.score).map(M=>M.position);if(t){if(n.length)return n;if(r.length)return r;if(a.length)return a;if(o.length&&!f.length&&!i.length)return o;if(f.length)return u.length?f.concat(u):f}else{if(r.length)return r;if(n.length)return n;if(f.length)return f;if(c.length&&!a.length&&!u.length)return c;if(a.length)return i.length?a.concat(i):a}return y=g.sort((M,v)=>v.score-M.score).map(M=>M.position),y.length<=this.genLimit?y:y.slice(0,this.genLimit)}const he=ot(1,2,3),fe=ot(2,1,3);class q{constructor(t){j(this,"genChilds",ce);j(this,"evaluate",ue);j(this,"evaluateOnlyLine",le);j(this,"serialPointMode",st);this.init({...t})}init({firstHand:t,autoPlay:e,enableStats:n,attackFactor:r,defenseFactor:a}){this.node0=[],this.node1=[],this.node2=[],this.node3=[],this.neighborNode=[],this.scoreNode=O(4,[]),this.initNode(),this.stack=[],this.zobrist=new ae({size:15}),this.maxPointsScore=O(15,O(15,[0,0,0,0])),this.minPointsScore=O(15,O(15,[0,0,0,0])),this.stats={},this.initStats(),this.enableStats=n!==void 0?n:!0,this.enableLog=!1,this.firstHand=t||2,this.genLimit=20,this.seekDepth=8,this.seekKillDepth=21,this.autoPlay=e||!1,this.attackFactor=r||1,this.defenseFactor=a||1,this.timeLimit=3e3}maxGo(){if(this.isFinal)return;console.log(Object.keys(this.zobrist.hash).length),this.initStats();const t=this.getMaxNextStep(),{i:e,j:n,score:r}=t;return this.put(e,n,1),this.logStats(),console.log({score:this.evaluate(),score2:r}),t}getMaxNextStep(){let t=this.genChilds(this.getAllOptimalNextStep(),!0);if(t=t.map(n=>({i:n[0],j:n[1]})),console.log({points:t}),t.length===1)return t[0];const e=this.seekKill();if(e)return e;this.startTime=+new Date,console.time("thinking");for(let n=2;n<=this.seekDepth&&(this.zobrist.resetHash(),!(+new Date-this.startTime>this.timeLimit));n+=2){for(let r=0;r<t.length;r++){let a=t[r];const{i:f,j:u}=a;this.put(f,u,1);const i=this.minimax(n-1,!1);this.rollback(),i.score!==-1/0&&(a.score=i.score,a.depth=n,a.stack=i.stack)}t=t.sort((r,a)=>a.score-r.score),console.log(n,t)}return console.timeEnd("thinking"),t[0]}seekKill(){if(this.stack.length>4){this.startTime=+new Date,console.time("thinking kill");for(let t=3;t<=this.seekKillDepth&&(this.zobrist.resetHash(),!(+new Date-this.startTime>this.timeLimit));t+=2){const e=this.minimax(t,!0,!0);if((e==null?void 0:e.score)>k.l5*.5)return console.warn("算杀成功 :)",e),this.logStats(),console.timeEnd("thinking kill"),e}console.timeEnd("thinking kill")}}minGo(t,e){if(!this.isFinal)return this.isEmptyPosition(t,e)?(this.put(t,e,2),console.log({score:this.evaluate()}),!0):!1}minimax(t,e=!0,n=!1,r=-1/0,a=1/0){if(this.isFinal||t===0)return{score:this.evaluate(n),depth:t};const f=this.genChilds(this.getAllOptimalNextStep(),e,n);if(e){if(f.length===0)return{score:-.1};let u=-1/0,i=f[0],l;for(const c of f){if(+new Date-this.startTime>this.timeLimit)break;const[d,g]=c;this.put(d,g,1),this.enableStats&&this.stats.abCut.eva++;let y=this.zobrist.get(),M;if(y===void 0){const v=this.minimax(t-1,!e,n,r,a);y=v.score,M=v.stack,this.zobrist.set(y),this.enableStats&&this.stats.zobrist.miss++}else this.enableStats&&this.stats.zobrist.hit++;if(this.rollback(),y>u&&(u=y,i=c,l=M),r=Math.max(r,u),a<=r){this.enableStats&&this.stats.abCut.cut++;break}}const[h,o]=i;return{score:u,i:h,j:o,stack:l}}else{if(f.length===0)return{score:.2};let u=1/0,i=f[0],l;for(const c of f){if(+new Date-this.startTime>this.timeLimit){u=-1/0;break}const[d,g]=c;this.put(d,g,2),this.enableStats&&this.stats.abCut.eva++;let y=this.zobrist.get(),M;if(y===void 0){const v=this.minimax(t-1,!e,n,r,a);y=v.score,M=v.stack,this.zobrist.set(y),this.enableStats&&this.stats.zobrist.miss++}else this.enableStats&&this.stats.zobrist.hit++;if(this.rollback(),y<u&&(u=y,i=c,l=M),a=Math.min(a,u),a<=r){this.enableStats&&this.stats.abCut.cut++;break}}const[h,o]=i;return{score:u,i:h,j:o,stack:l}}}isWall(t,e){return t<0||t>=15||e<0||e>=15}initNode(){this.node0=O(15,0),this.node1=O(15,0),this.node2=[];for(let t=0;t<15*2-1;t++){let e=0;for(let n=0;n<15;n++){const r=t-n;e<<=2,this.isWall(n,r)&&(e+=3)}this.node2[t]=e}this.node3=[];for(let t=0;t<15*2-1;t++){let e=0;for(let n=0;n<15;n++){const r=14+n-t;e<<=2,this.isWall(n,r)&&(e+=3)}this.node3[t]=e}this.neighborNode=O(15,O(15,0))}put(t,e,n){this.zobrist.go(t,e,n===1),this.stack.push([t,e]),this.node0[t]=this.node0[t]|n<<2*(14-e),this.node1[e]=this.node1[e]|n<<2*(14-t),this.node2[t+e]=this.node2[t+e]|n<<2*(14-t),this.node3[14+t-e]=this.node3[14+t-e]|n<<2*(14-t),this.updateNeighbor(t,e,!0),this.updatePointScore(t,e),this.updateScoreNode(t,e)}rollback(t=1){if(!(this.stack.length<t))for(;t-- >0;){const[e,n]=this.stack.pop();this.zobrist.go(e,n,this.getChess(e,n)===1);const r=2*(14-n);this.node0[e]=(this.node0[e]|3<<r)^3<<r;const a=2*(14-e);this.node1[n]=(this.node1[n]|3<<a)^3<<a,this.node2[e+n]=(this.node2[e+n]|3<<a)^3<<a,this.node3[14+e-n]=(this.node3[14+e-n]|3<<a)^3<<a,this.updateNeighbor(e,n,!1),this.updatePointScore(e,n),this.updateScoreNode(e,n)}}minRepent(){this.stack.length>=2&&this.rollback(2)}isEmptyPosition(t,e){return!this.isWall(t,e)&&this.getChess(t,e)===0}getAllOptimalNextStep(){if(this.stack.length===0)return[[7,7]];if(this.stack.length===1){if(this.isEmptyPosition(7,7))return[[7,7]];const e=7+(Math.random()>.5?1:-1),n=7+(Math.random()>.5?1:-1);return[[e,n]]}let t=[];for(let e=0;e<15;e++)for(let n=0;n<15;n++)this.neighborNode[e][n]>0&&t.push([e,n]);return t}updateNeighbor(t,e,n){n?this.neighborNode[t][e]-=64:this.neighborNode[t][e]+=64;const r=2;for(let a=-r;a<=r;a++)if(!(a+t<0||a+t>=15))for(let f=-r;f<=r;f++)f+e<0||f+e>=15||a===0&&f===0||(n?this.neighborNode[a+t][e+f]+=1:this.neighborNode[a+t][e+f]-=1)}updateScoreNode(t,e){this.scoreNode[0][t]=this.evaluateOnlyLine(this.node0,t),this.scoreNode[1][e]=this.evaluateOnlyLine(this.node1,e),this.scoreNode[2][t+e]=this.evaluateOnlyLine(this.node2,t+e),this.scoreNode[3][14+t-e]=this.evaluateOnlyLine(this.node3,14+t-e)}getChess(t,e){return this.node0[t]>>2*(14-e)&3}getChessInFourDirection(t,e,n){if(n===0){const r=this.node0[t],a=e>=4?r>>2*(18-e)&3:3,f=e>=3?r>>2*(17-e)&3:3,u=e>=2?r>>2*(16-e)&3:3,i=e>=1?r>>2*(15-e)&3:3,l=r>>2*(14-e)&3,h=e<=13?r>>2*(13-e)&3:3,o=e<=12?r>>2*(12-e)&3:3,c=e<=11?r>>2*(11-e)&3:3,d=e<=10?r>>2*(10-e)&3:3;return[a,f,u,i,l,h,o,c,d]}else{let r;n===1?r=this.node1[e]:n===2?r=this.node2[t+e]:n===3&&(r=this.node3[14+t-e]);const a=t>=4?r>>2*(18-t)&3:3,f=t>=3?r>>2*(17-t)&3:3,u=t>=2?r>>2*(16-t)&3:3,i=t>=1?r>>2*(15-t)&3:3,l=r>>2*(14-t)&3,h=t<=13?r>>2*(13-t)&3:3,o=t<=12?r>>2*(12-t)&3:3,c=t<=11?r>>2*(11-t)&3:3,d=t<=10?r>>2*(10-t)&3:3;return[a,f,u,i,l,h,o,c,d]}}getPositionsInFourDirection(t,e){let n=[],r=[],a=[],f=[];const u=t-4>0?t-4:0,i=t+4<15-1?t+4:15-1,l=e-4>0?e-4:0,h=e+4<15-1?e+4:15-1;for(let o=l;o<=h;o++)n.push([t,o]);for(let o=u;o<=i;o++)r.push([o,e]);for(let o=4;o>0;o--)t-o>=u&&e+o<=h&&a.push([t-o,e+o]);a.push([t,e]);for(let o=1;o<=4;o++)t+o<=i&&e-o>=l&&a.push([t+o,e-o]);for(let o=4;o>0;o--)t-o>=u&&e-o>=l&&f.push([t-o,e-o]);f.push([t,e]);for(let o=1;o<=4;o++)t+o<=i&&e+o<=h&&f.push([t+o,e+o]);return[n,r,a,f]}updatePointScore(t,e){const n=this.getPositionsInFourDirection(t,e);for(let r=0;r<4;r++){const a=n[r];for(let f=0;f<a.length;f++){const[u,i]=a[f];if(this.getChess(u,i)!==0)this.maxPointsScore[u][i]=[0,0,0,0],this.minPointsScore[u][i]=[0,0,0,0];else{const l=this.getChessInFourDirection(u,i,r);this.maxPointsScore[u][i][r]=this.serialPointMode[he(l)]||0,this.minPointsScore[u][i][r]=this.serialPointMode[fe(l)]||0}}}}saveStack(){console.log(JSON.stringify(this.stack))}restoreStack(t){const e=this.firstHand,n=e===1?2:1;this.rollback(this.stack.length);for(let r=0;r<t.length;r++){const[a,f]=t[r],u=r%2===0?e:n;this.put(a,f,u)}}test(t){console.log(Function(t).call(this))}get winner(){if(this.stack.length<7)return null;const[t,e]=this.stack[this.stack.length-1],n=this.getChess(t,e),r=[this.getChessInFourDirection(t,e,0),this.getChessInFourDirection(t,e,1),this.getChessInFourDirection(t,e,2),this.getChessInFourDirection(t,e,3)];for(let a=0;a<4;a++){let f=0;const u=r[a];for(let i=0;i<u.length;i++)if(u[i]===n?f++:f=0,f===5)return n}return null}get winnerPositions(){if(!this.winner)return null;const[t,e]=this.stack[this.stack.length-1],n=this.getChess(t,e),r=this.getPositionsInFourDirection(t,e);for(let a=0;a<4;a++){const f=r[a];let u=0,i=[];for(let l=0;l<f.length;l++){const[h,o]=f[l];if(this.getChess(h,o)===n?(u++,i.push([h,o])):(u=0,i=[]),u===5)return i}}return null}get isFinal(){return!!this.winner||this.isBoardFull}get isBoardFull(){return this.stack.length===15**2}get lastChessPosition(){return this.stack.length?this.stack[this.stack.length-1]:null}get isDraw(){return this.isBoardFull&&!this.winner}get node(){return this.node0.map(t=>{let e=[];for(let n=0;n<15;n++)e.push((t&3<<2*n)>>2*n);return e.reverse()})}printNode(){console.log(this.node0.map(t=>t.toString(2))),console.log(this.node1.map(t=>t.toString(2))),console.log(this.node2.map(t=>t.toString(2))),console.log(this.node3.map(t=>t.toString(2)))}initStats(){this.stats={abCut:{all:this.genLimit**this.seekDepth,eva:0,cut:0,toString(){const{all:t,eva:e,cut:n}=this.stats.abCut,r=t-e;return`AB剪枝 最大节点总数:${t} 理论最少评估${t**.5>>0} 实际评估:${e} 剪去:${n}/${r}`}},zobrist:{miss:0,hit:0,toString(){const{hit:t,miss:e}=this.stats.zobrist;return`zobrist 评估节点数:${this.stats.abCut.eva} hit:${t} miss:${e}`}}}}logStats(){this.enableStats&&Object.keys(this.stats).forEach(t=>{console.log(this.stats[t].toString.call(this))})}}j(q,"MAX",1),j(q,"MIN",2),j(q,"EMPTY",0),j(q,"WALL",3);let _=new q;onmessage=async function(s){const{type:t,data:e}=s.data;let n;switch(t){case"init":_.init(e),_.autoPlay&&de();break;case"maxGo":n=_.maxGo();break;case"minGo":n=_.minGo(...e);break;case"minRepent":n=_.minRepent();break;case"reStart":n=_.init({});break;case"test":n=_.test(e);break}R(t,n)};const R=(s,t)=>postMessage({type:s,data:t,gobang:JSON.stringify({..._,node:_.node,stack:_.stack,firstHand:_.firstHand,lastChessPosition:_.lastChessPosition,winnerPositions:_.winnerPositions,isDraw:_.isDraw,winner:_.winner,isFinal:_.isFinal})});self.gobang=_,self.sendMessage=R;const de=async()=>{const s=new q({firstHand:q.MIN,seekDepth:2,defenseFactor:4});_.genLimit=30,_.seekDepth=8,s.seekDepth=4,s.genLimit=60,s.defenseFactor=1;const t=async()=>{if(_.isFinal)return;const{i:r,j:a}=_.maxGo();s.minGo(r,a),R("autoPlay")},e=async()=>{if(_.isFinal)return;const{i:r,j:a}=s.maxGo();_.minGo(r,a),R("autoPlay")},n=500;for(;_.autoPlay&&!_.isFinal;)await t(),await at(n),await e(),await at(n)}})();
