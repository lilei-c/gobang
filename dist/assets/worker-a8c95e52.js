var de=Object.defineProperty;var ge=(B,z,H)=>z in B?de(B,z,{enumerable:!0,configurable:!0,writable:!0,value:H}):B[z]=H;var I=(B,z,H)=>(ge(B,typeof z!="symbol"?z+"":z,H),H);(function(){"use strict";const rt={l1:1,d2:8,l2:64,d3:512,l3:4096,d4:16384,l4:65536,l5:262144},O=s=>({l1:s&7,d2:s>>3&7,l2:s>>6&7,d3:s>>9&7,l3:s>>12&3,d4:s>>14&3,l4:s>>16&3,l5:s>>18&3});console.log("getPointMode");const m={l1:1,d2:2,l2:8,d3:12,l3:30,d4:50,l4:500,l5:1e3,win:1e4};console.log("getPoinScoretMode");const ot=s=>{const{l5:t,l4:e,d4:n,l3:i,d3:a,l2:f,d2:u,l1:r}=s;let l=0;return t&&(l+=m.l5*t),e&&(l+=m.l4*e),n&&(l+=m.d4*n),i&&(l+=m.l3*i),a&&(l+=m.d3*a),f&&(l+=m.l2*f),u&&(l+=m.d2*u),r&&(l+=m.l1*r),l};console.log("calcEvaPointScore"),console.warn("todo: 测试 countLine 是否正确");const st=(s,t,e)=>n=>{let i=1;for(let a=0;a<4;a++){const f=n[a];i<<=1,f===s?i|=1:(f===t||f===e)&&(i=1)}i=i<<1|1;for(let a=5;a<9;a++){const f=n[a];if(f===t||f===e)break;i<<=1,f===s&&(i|=1)}return i};console.log("countLine");const Y=(s=>Array.from({length:1<<s+1},(t,e)=>`0b${e.toString(2)}`))(12);console.log(Y.length),Y.forEach(s=>null);const W=[],wt={l1:s=>/010/.test(s)&&s.length>5,d2:s=>/10{0,1}1/.test(s)&&s.length>=5,l2:s=>[/000110/,/001100/,/011000/,/001010/,/010100/].some(t=>t.test(s)),d3:s=>[/111/,/1011/,/1101/,/11001/,/10011/,/10101/].some(t=>t.test(s))&&s.length>=5,l3:s=>[/010110/,/011010/,/01110/,/1010101/].some(t=>t.test(s)),d4:s=>[/11110/,/01111/,/11011/,/11101/,/10111/].some(t=>t.test(s)),l4:s=>[/011110/,/1011101/,/11011011/,/111010111/].some(t=>t.test(s)),l5:s=>/1{5}/.test(s)};for(const[s,t]of Object.entries(wt))Y.forEach(e=>{t(e.slice(3))&&(W[+e]=rt[s])});console.log("allModes.forEach");const F=(s,t=void 0,e=!1)=>(typeof t=="object"&&!e&&console.error(`
    val 为"引用类型"时, 请明确传递参数 yesHereIsObjectVal
    另外: 对于"引用类型", arrayN 使用 structuredClone 处理 val, 防止多个变量指向相同引用`),Array(s).fill().map(()=>structuredClone(t))),at=s=>new Promise(t=>setTimeout(t,s));var G=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function yt(s){if(s.__esModule)return s;var t=s.default;if(typeof t=="function"){var e=function n(){if(this instanceof n){var i=[null];i.push.apply(i,arguments);var a=Function.bind.apply(t,i);return new a}return t.apply(this,arguments)};e.prototype=t.prototype}else e={};return Object.defineProperty(e,"__esModule",{value:!0}),Object.keys(s).forEach(function(n){var i=Object.getOwnPropertyDescriptor(s,n);Object.defineProperty(e,n,i.get?i:{enumerable:!0,get:function(){return s[n]}})}),e}var V={},Mt={get exports(){return V},set exports(s){V=s}};(function(s){(function(t,e,n){function i(r){var l=this,h=u();l.next=function(){var o=2091639*l.s0+l.c*23283064365386963e-26;return l.s0=l.s1,l.s1=l.s2,l.s2=o-(l.c=o|0)},l.c=1,l.s0=h(" "),l.s1=h(" "),l.s2=h(" "),l.s0-=h(r),l.s0<0&&(l.s0+=1),l.s1-=h(r),l.s1<0&&(l.s1+=1),l.s2-=h(r),l.s2<0&&(l.s2+=1),h=null}function a(r,l){return l.c=r.c,l.s0=r.s0,l.s1=r.s1,l.s2=r.s2,l}function f(r,l){var h=new i(r),o=l&&l.state,c=h.next;return c.int32=function(){return h.next()*4294967296|0},c.double=function(){return c()+(c()*2097152|0)*11102230246251565e-32},c.quick=c,o&&(typeof o=="object"&&a(o,h),c.state=function(){return a(h,{})}),c}function u(){var r=4022871197,l=function(h){h=String(h);for(var o=0;o<h.length;o++){r+=h.charCodeAt(o);var c=.02519603282416938*r;r=c>>>0,c-=r,c*=r,r=c>>>0,c-=r,r+=c*4294967296}return(r>>>0)*23283064365386963e-26};return l}e&&e.exports?e.exports=f:n&&n.amd?n(function(){return f}):this.alea=f})(G,s,!1)})(Mt);var K={},St={get exports(){return K},set exports(s){K=s}};(function(s){(function(t,e,n){function i(u){var r=this,l="";r.x=0,r.y=0,r.z=0,r.w=0,r.next=function(){var o=r.x^r.x<<11;return r.x=r.y,r.y=r.z,r.z=r.w,r.w^=r.w>>>19^o^o>>>8},u===(u|0)?r.x=u:l+=u;for(var h=0;h<l.length+64;h++)r.x^=l.charCodeAt(h)|0,r.next()}function a(u,r){return r.x=u.x,r.y=u.y,r.z=u.z,r.w=u.w,r}function f(u,r){var l=new i(u),h=r&&r.state,o=function(){return(l.next()>>>0)/4294967296};return o.double=function(){do var c=l.next()>>>11,d=(l.next()>>>0)/4294967296,p=(c+d)/(1<<21);while(p===0);return p},o.int32=l.next,o.quick=o,h&&(typeof h=="object"&&a(h,l),o.state=function(){return a(l,{})}),o}e&&e.exports?e.exports=f:n&&n.amd?n(function(){return f}):this.xor128=f})(G,s,!1)})(St);var Z={},kt={get exports(){return Z},set exports(s){Z=s}};(function(s){(function(t,e,n){function i(u){var r=this,l="";r.next=function(){var o=r.x^r.x>>>2;return r.x=r.y,r.y=r.z,r.z=r.w,r.w=r.v,(r.d=r.d+362437|0)+(r.v=r.v^r.v<<4^(o^o<<1))|0},r.x=0,r.y=0,r.z=0,r.w=0,r.v=0,u===(u|0)?r.x=u:l+=u;for(var h=0;h<l.length+64;h++)r.x^=l.charCodeAt(h)|0,h==l.length&&(r.d=r.x<<10^r.x>>>4),r.next()}function a(u,r){return r.x=u.x,r.y=u.y,r.z=u.z,r.w=u.w,r.v=u.v,r.d=u.d,r}function f(u,r){var l=new i(u),h=r&&r.state,o=function(){return(l.next()>>>0)/4294967296};return o.double=function(){do var c=l.next()>>>11,d=(l.next()>>>0)/4294967296,p=(c+d)/(1<<21);while(p===0);return p},o.int32=l.next,o.quick=o,h&&(typeof h=="object"&&a(h,l),o.state=function(){return a(l,{})}),o}e&&e.exports?e.exports=f:n&&n.amd?n(function(){return f}):this.xorwow=f})(G,s,!1)})(kt);var U={},Pt={get exports(){return U},set exports(s){U=s}};(function(s){(function(t,e,n){function i(u){var r=this;r.next=function(){var h=r.x,o=r.i,c,d;return c=h[o],c^=c>>>7,d=c^c<<24,c=h[o+1&7],d^=c^c>>>10,c=h[o+3&7],d^=c^c>>>3,c=h[o+4&7],d^=c^c<<7,c=h[o+7&7],c=c^c<<13,d^=c^c<<9,h[o]=d,r.i=o+1&7,d};function l(h,o){var c,d=[];if(o===(o|0))d[0]=o;else for(o=""+o,c=0;c<o.length;++c)d[c&7]=d[c&7]<<15^o.charCodeAt(c)+d[c+1&7]<<13;for(;d.length<8;)d.push(0);for(c=0;c<8&&d[c]===0;++c);for(c==8?d[7]=-1:d[c],h.x=d,h.i=0,c=256;c>0;--c)h.next()}l(r,u)}function a(u,r){return r.x=u.x.slice(),r.i=u.i,r}function f(u,r){u==null&&(u=+new Date);var l=new i(u),h=r&&r.state,o=function(){return(l.next()>>>0)/4294967296};return o.double=function(){do var c=l.next()>>>11,d=(l.next()>>>0)/4294967296,p=(c+d)/(1<<21);while(p===0);return p},o.int32=l.next,o.quick=o,h&&(h.x&&a(h,l),o.state=function(){return a(l,{})}),o}e&&e.exports?e.exports=f:n&&n.amd?n(function(){return f}):this.xorshift7=f})(G,s,!1)})(Pt);var Q={},Lt={get exports(){return Q},set exports(s){Q=s}};(function(s){(function(t,e,n){function i(u){var r=this;r.next=function(){var h=r.w,o=r.X,c=r.i,d,p;return r.w=h=h+1640531527|0,p=o[c+34&127],d=o[c=c+1&127],p^=p<<13,d^=d<<17,p^=p>>>15,d^=d>>>12,p=o[c]=p^d,r.i=c,p+(h^h>>>16)|0};function l(h,o){var c,d,p,w,S,v=[],D=128;for(o===(o|0)?(d=o,o=null):(o=o+"\0",d=0,D=Math.max(D,o.length)),p=0,w=-32;w<D;++w)o&&(d^=o.charCodeAt((w+32)%o.length)),w===0&&(S=d),d^=d<<10,d^=d>>>15,d^=d<<4,d^=d>>>13,w>=0&&(S=S+1640531527|0,c=v[w&127]^=d+S,p=c==0?p+1:0);for(p>=128&&(v[(o&&o.length||0)&127]=-1),p=127,w=4*128;w>0;--w)d=v[p+34&127],c=v[p=p+1&127],d^=d<<13,c^=c<<17,d^=d>>>15,c^=c>>>12,v[p]=d^c;h.w=S,h.X=v,h.i=p}l(r,u)}function a(u,r){return r.i=u.i,r.w=u.w,r.X=u.X.slice(),r}function f(u,r){u==null&&(u=+new Date);var l=new i(u),h=r&&r.state,o=function(){return(l.next()>>>0)/4294967296};return o.double=function(){do var c=l.next()>>>11,d=(l.next()>>>0)/4294967296,p=(c+d)/(1<<21);while(p===0);return p},o.int32=l.next,o.quick=o,h&&(h.X&&a(h,l),o.state=function(){return a(l,{})}),o}e&&e.exports?e.exports=f:n&&n.amd?n(function(){return f}):this.xor4096=f})(G,s,!1)})(Lt);var J={},_t={get exports(){return J},set exports(s){J=s}};(function(s){(function(t,e,n){function i(u){var r=this,l="";r.next=function(){var o=r.b,c=r.c,d=r.d,p=r.a;return o=o<<25^o>>>7^c,c=c-d|0,d=d<<24^d>>>8^p,p=p-o|0,r.b=o=o<<20^o>>>12^c,r.c=c=c-d|0,r.d=d<<16^c>>>16^p,r.a=p-o|0},r.a=0,r.b=0,r.c=-1640531527,r.d=1367130551,u===Math.floor(u)?(r.a=u/4294967296|0,r.b=u|0):l+=u;for(var h=0;h<l.length+20;h++)r.b^=l.charCodeAt(h)|0,r.next()}function a(u,r){return r.a=u.a,r.b=u.b,r.c=u.c,r.d=u.d,r}function f(u,r){var l=new i(u),h=r&&r.state,o=function(){return(l.next()>>>0)/4294967296};return o.double=function(){do var c=l.next()>>>11,d=(l.next()>>>0)/4294967296,p=(c+d)/(1<<21);while(p===0);return p},o.int32=l.next,o.quick=o,h&&(typeof h=="object"&&a(h,l),o.state=function(){return a(l,{})}),o}e&&e.exports?e.exports=f:n&&n.amd?n(function(){return f}):this.tychei=f})(G,s,!1)})(_t);var tt={},At={get exports(){return tt},set exports(s){tt=s}},Et={},Ct=Object.freeze({__proto__:null,default:Et}),Nt=yt(Ct);(function(s){(function(t,e,n){var i=256,a=6,f=52,u="random",r=n.pow(i,a),l=n.pow(2,f),h=l*2,o=i-1,c;function d(x,M,P){var k=[];M=M==!0?{entropy:!0}:M||{};var b=v(S(M.entropy?[x,C(e)]:x??D(),3),k),g=new p(k),y=function(){for(var L=g.g(a),_=r,E=0;L<l;)L=(L+E)*i,_*=i,E=g.g(1);for(;L>=h;)L/=2,_/=2,E>>>=1;return(L+E)/_};return y.int32=function(){return g.g(4)|0},y.quick=function(){return g.g(4)/4294967296},y.double=y,v(C(g.S),e),(M.pass||P||function(L,_,E,N){return N&&(N.S&&w(N,g),L.state=function(){return w(g,{})}),E?(n[u]=L,_):L})(y,b,"global"in M?M.global:this==n,M.state)}function p(x){var M,P=x.length,k=this,b=0,g=k.i=k.j=0,y=k.S=[];for(P||(x=[P++]);b<i;)y[b]=b++;for(b=0;b<i;b++)y[b]=y[g=o&g+x[b%P]+(M=y[b])],y[g]=M;(k.g=function(L){for(var _,E=0,N=k.i,T=k.j,X=k.S;L--;)_=X[N=o&N+1],E=E*i+X[o&(X[N]=X[T=o&T+_])+(X[T]=_)];return k.i=N,k.j=T,E})(i)}function w(x,M){return M.i=x.i,M.j=x.j,M.S=x.S.slice(),M}function S(x,M){var P=[],k=typeof x,b;if(M&&k=="object")for(b in x)try{P.push(S(x[b],M-1))}catch{}return P.length?P:k=="string"?x:x+"\0"}function v(x,M){for(var P=x+"",k,b=0;b<P.length;)M[o&b]=o&(k^=M[o&b]*19)+P.charCodeAt(b++);return C(M)}function D(){try{var x;return c&&(x=c.randomBytes)?x=x(i):(x=new Uint8Array(i),(t.crypto||t.msCrypto).getRandomValues(x)),C(x)}catch{var M=t.navigator,P=M&&M.plugins;return[+new Date,t,P,t.screen,C(e)]}}function C(x){return String.fromCharCode.apply(0,x)}if(v(n.random(),e),s.exports){s.exports=d;try{c=Nt}catch{}}else n["seed"+u]=d})(typeof self<"u"?self:G,[],Math)})(At);var Dt=V,jt=K,Ft=Z,Tt=U,Xt=Q,zt=J,$=tt;$.alea=Dt,$.xor128=jt,$.xorwow=Ft,$.xorshift7=Tt,$.xor4096=Xt,$.tychei=zt;var Ot=$;function lt(s,t){for(var e=0;e<t.length;e++){var n=t[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(s,Gt(n.key),n)}}function et(s,t,e){return t&&lt(s.prototype,t),e&&lt(s,e),Object.defineProperty(s,"prototype",{writable:!1}),s}function ut(s,t){s.prototype=Object.create(t.prototype),s.prototype.constructor=s,nt(s,t)}function nt(s,t){return nt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(n,i){return n.__proto__=i,n},nt(s,t)}function It(s,t){if(typeof s!="object"||s===null)return s;var e=s[Symbol.toPrimitive];if(e!==void 0){var n=e.call(s,t||"default");if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(s)}function Gt(s){var t=It(s,"string");return typeof t=="symbol"?t:String(t)}var R=function(){function s(){}var t=s.prototype;return t._seed=function(n,i){if(n===(n||0))return n;for(var a=""+n,f=0,u=0;u<a.length;++u)f^=a.charCodeAt(u)|0;return f},s}(),ct=function(s){ut(t,s);function t(n,i){var a;return a=s.call(this)||this,a._rng=void 0,a.seed(n,i),a}var e=t.prototype;return e.next=function(){return this._rng()},e.seed=function(i,a){this._rng=i},e.clone=function(i,a){return new t(this._rng,a)},et(t,[{key:"name",get:function(){return"function"}}]),t}(R),ht=function(){var s=[].slice.call(arguments),t=s,e=t[0],n=e===void 0?"default":e;switch(typeof n){case"object":if(n instanceof R)return n;break;case"function":return new ct(n);case"number":case"string":default:return new ct(Ot.apply(void 0,s))}throw new Error('invalid RNG "'+n+'"')},$t=function(s,t,e){return t===void 0&&(t=0),e===void 0&&(e=1),function(){return s.next()*(e-t)+t}};function j(s){return new qt(s)}var qt=function(t){var e=this;this.n=void 0,this.isInt=function(){if(Number.isInteger(e.n))return e;throw new Error("Expected number to be an integer, got "+e.n)},this.isPositive=function(){if(e.n>0)return e;throw new Error("Expected number to be positive, got "+e.n)},this.lessThan=function(n){if(e.n<n)return e;throw new Error("Expected number to be less than "+n+", got "+e.n)},this.greaterThanOrEqual=function(n){if(e.n>=n)return e;throw new Error("Expected number to be greater than or equal to "+n+", got "+e.n)},this.greaterThan=function(n){if(e.n>n)return e;throw new Error("Expected number to be greater than "+n+", got "+e.n)},this.n=t},Bt=function(s,t,e){return t===void 0&&(t=0),e===void 0&&(e=1),e===void 0&&(e=t===void 0?1:t,t=0),j(t).isInt(),j(e).isInt(),function(){return Math.floor(s.next()*(e-t+1)+t)}},Ht=function(s){return function(){return s.next()>=.5}},Wt=function(s,t,e){return t===void 0&&(t=0),e===void 0&&(e=1),function(){var n,i,a;do n=s.next()*2-1,i=s.next()*2-1,a=n*n+i*i;while(!a||a>1);return t+e*i*Math.sqrt(-2*Math.log(a)/a)}},Rt=function(s,t,e){t===void 0&&(t=0),e===void 0&&(e=1);var n=s.normal(t,e);return function(){return Math.exp(n())}},Yt=function(s,t){return t===void 0&&(t=.5),j(t).greaterThanOrEqual(0).lessThan(1),function(){return Math.floor(s.next()+t)}},Vt=function(s,t,e){return t===void 0&&(t=1),e===void 0&&(e=.5),j(t).isInt().isPositive(),j(e).greaterThanOrEqual(0).lessThan(1),function(){for(var n=0,i=0;n++<t;)s.next()<e&&i++;return i}},Kt=function(s,t){t===void 0&&(t=.5),j(t).greaterThan(0).lessThan(1);var e=1/Math.log(1-t);return function(){return Math.floor(1+Math.log(s.next())*e)}},Zt=[0,0,.6931471805599453,1.791759469228055,3.1780538303479458,4.787491742782046,6.579251212010101,8.525161361065415,10.60460290274525,12.801827480081469],Ut=function(t){return Zt[t]},Qt=.9189385332046727,Jt=function(s,t){if(t===void 0&&(t=1),j(t).isPositive(),t<10){var e=Math.exp(-t);return function(){for(var r=e,l=0,h=s.next();h>r;)h=h-r,r=t*r/++l;return l}}else{var n=Math.sqrt(t),i=.931+2.53*n,a=-.059+.02483*i,f=1.1239+1.1328/(i-3.4),u=.9277-3.6224/(i-2);return function(){for(;;){var r=void 0,l=s.next();if(l<=.86*u)return r=l/u-.43,Math.floor((2*a/(.5-Math.abs(r))+i)*r+t+.445);l>=u?r=s.next()-.5:(r=l/u-.93,r=(r<0?-.5:.5)-r,l=s.next()*u);var h=.5-Math.abs(r);if(!(h<.013&&l>h)){var o=Math.floor((2*a/h+i)*r+t+.445);if(l=l*f/(a/(h*h)+i),o>=10){var c=(o+.5)*Math.log(t/o)-t-Qt+o-(.08333333333333333-(.002777777777777778-1/(1260*o*o))/(o*o))/o;if(Math.log(l*n)<=c)return o}else if(o>=0){var d,p=(d=Ut(o))!=null?d:0;if(Math.log(l)<=o*Math.log(t)-t-p)return o}}}}}},te=function(s,t){return t===void 0&&(t=1),j(t).isPositive(),function(){return-Math.log(1-s.next())/t}},ee=function(s,t){return t===void 0&&(t=1),j(t).isInt().greaterThanOrEqual(0),function(){for(var e=0,n=0;n<t;++n)e+=s.next();return e}},ne=function(s,t){t===void 0&&(t=1),j(t).isInt().isPositive();var e=s.irwinHall(t);return function(){return e()/t}},ie=function(s,t){t===void 0&&(t=1),j(t).greaterThanOrEqual(0);var e=1/t;return function(){return 1/Math.pow(1-s.next(),e)}},re=function(s){ut(t,s);function t(){return s.apply(this,arguments)||this}var e=t.prototype;return e.next=function(){return Math.random()},e.seed=function(i,a){},e.clone=function(){return new t},et(t,[{key:"name",get:function(){return"default"}}]),t}(R),oe=function(){function s(e){var n=this;this._rng=void 0,this._patch=void 0,this._cache={},this.next=function(){return n._rng.next()},this.float=function(i,a){return n.uniform(i,a)()},this.int=function(i,a){return n.uniformInt(i,a)()},this.integer=function(i,a){return n.uniformInt(i,a)()},this.bool=function(){return n.uniformBoolean()()},this.boolean=function(){return n.uniformBoolean()()},this.uniform=function(i,a){return n._memoize("uniform",$t,i,a)},this.uniformInt=function(i,a){return n._memoize("uniformInt",Bt,i,a)},this.uniformBoolean=function(){return n._memoize("uniformBoolean",Ht)},this.normal=function(i,a){return Wt(n,i,a)},this.logNormal=function(i,a){return Rt(n,i,a)},this.bernoulli=function(i){return Yt(n,i)},this.binomial=function(i,a){return Vt(n,i,a)},this.geometric=function(i){return Kt(n,i)},this.poisson=function(i){return Jt(n,i)},this.exponential=function(i){return te(n,i)},this.irwinHall=function(i){return ee(n,i)},this.bates=function(i){return ne(n,i)},this.pareto=function(i){return ie(n,i)},e&&e instanceof R?this.use(e):this.use(new re),this._cache={}}var t=s.prototype;return t.clone=function(){var n=[].slice.call(arguments);return n.length?new s(ht.apply(void 0,n)):new s(this.rng.clone())},t.use=function(){this._rng=ht.apply(void 0,[].slice.call(arguments))},t.patch=function(){if(this._patch)throw new Error("Math.random already patched");this._patch=Math.random,Math.random=this.uniform()},t.unpatch=function(){this._patch&&(Math.random=this._patch,delete this._patch)},t.choice=function(n){if(!Array.isArray(n))throw new Error("Random.choice expected input to be an array, got "+typeof n);var i=n==null?void 0:n.length;if(i>0){var a=this.uniformInt(0,i-1)();return n[a]}else return},t._memoize=function(n,i){var a=[].slice.call(arguments,2),f=""+a.join(";"),u=this._cache[n];return(u===void 0||u.key!==f)&&(u={key:f,distribution:i.apply(void 0,[this].concat(a))},this._cache[n]=u),u.distribution},et(s,[{key:"rng",get:function(){return this._rng}}]),s}(),se=new oe;class ae{constructor({size:t,randFn:e}){e||(e=()=>se.int(0,2**31)),this.max=F(t).map(n=>F(t).map(e)),this.min=F(t).map(n=>F(t).map(e)),this.code=e(),this.hash={}}go(t,e,n){this.code^=n?this.max[t][e]:this.min[t][e]}get(){return this.hash[this.code]}set(t){this.hash[this.code]=t}resetHash(){this.hash={}}}const{l1:ft,d2:dt,l2:gt,d3:pt,l3:xt,d4:vt,l4:bt,l5:mt}=rt;function le(s,t){const e=this.winner;if(e===1)return m.win;if(e===2)return-m.win;if(s)return 0;let n=0,i=0,a=0,f=0,u=0,r=0,l=0,h=0,o=0,c=0,d=0,p=0,w=0,S=0,v=0,D=0;const C=(g,y)=>{if(y<34)return;const L=this.serialPointMode[y];if(L)if(g===1)switch(L){case ft:return h++;case dt:return l++;case gt:return r++;case pt:return u++;case xt:return f++;case vt:return a++;case bt:return i++;case mt:return n++;default:return console.error("error")}else switch(L){case ft:return D++;case dt:return v++;case gt:return S++;case pt:return w++;case xt:return p++;case vt:return d++;case bt:return c++;case mt:return o++;default:return console.error("error")}},x=(g,y,L)=>{if(L===0)return;let _=1,E=0,N=!1;for(let T=0;T<15;T++){const X=L&3;if(L>>=2,X===y||X===3){C(g,_),_=1,N=!0;continue}else if(X===0)if(E===0)E++,_<<=1;else{_<<=1,!(L&12)&&T!==14&&(_<<=1),C(g,_),_=4,!(L&12)&&T!==14&&(_<<=1),E=0,N=!0;continue}else E=0,N=!1,_=(_<<1)+1}N||C(g,_)};for(let g=0;g<this.node0.length;g++)x(1,2,this.node0[g]);for(let g=0;g<this.node1.length;g++)x(1,2,this.node1[g]);for(let g=0;g<this.node2.length;g++)x(1,2,this.node2[g]);for(let g=0;g<this.node3.length;g++)x(1,2,this.node3[g]);for(let g=0;g<this.node0.length;g++)x(2,1,this.node0[g]);for(let g=0;g<this.node1.length;g++)x(2,1,this.node1[g]);for(let g=0;g<this.node2.length;g++)x(2,1,this.node2[g]);for(let g=0;g<this.node3.length;g++)x(2,1,this.node3[g]);t&&(console.log({maxL1:h,maxD2:l,maxL2:r,maxD3:u,maxL3:f,maxD4:a,maxL4:i,maxL5:n}),console.log({minL1:D,minD2:v,minL2:S,minD3:w,minL3:p,minD4:d,minL4:c,minL5:o}));let M=0,P=0;if((this.seekDepth&1)===0){if(i)return m.l5*2;if(a)return m.l5*3;if(c)return-m.l5;if(d>1||p>1||p&&d)return-m.l5*3;f&&!c&&!d&&(M+=m.l4)}else{if(c||d)return-m.l5;if(i)return m.l5;if(a>1||f>1||f&&a)return-m.l5*2;p&&!i&&!a&&(P+=m.l4)}return M=m.l5*n+m.l4*i+m.d4*a+m.l3*f+m.d3*u+m.l2*r+m.d2*l+m.l1*l,P=m.l5*o+m.l4*c+m.d4*d+m.l3*p+m.d3*w+m.l2*S+m.d2*v+m.l1*v,M*this.attackFactor-P*(this.firstHand===2?this.defenseFactor:1)}function ue(s,t,e){let n=[],i=[],a=[],f=[],u=[],r=[],l=[],h=[],o=[],c=[],d=[],p=[];for(let S=0;S<s.length;S++){const v=s[S],[D,C]=v;let x=0,M=0,P=O(this.maxPointsScore[D][C][0]);{const b=O(this.maxPointsScore[D][C][1]),g=O(this.maxPointsScore[D][C][2]),y=O(this.maxPointsScore[D][C][3]);P.l5+=b.l5+g.l5+y.l5,P.l4+=b.l4+g.l4+y.l4,P.d4+=b.d4+g.d4+y.d4,P.l3+=b.l3+g.l3+y.l3,P.d3+=b.d3+g.d3+y.d3,P.l2+=b.l2+g.l2+y.l2,P.d2+=b.d2+g.d2+y.d2,P.l1+=b.l1+g.l1+y.l1;const{l5:L,l4:_,d4:E,l3:N}=P;L?n.push(v):_?a.push(v):(E>1&&h.push(v),N&&E&&o.push(v),N>1&&d.push(v),N&&l.push(v),E&&u.push(v)),x=ot(P)}let k=O(this.minPointsScore[D][C][0]);{const b=O(this.minPointsScore[D][C][1]),g=O(this.minPointsScore[D][C][2]),y=O(this.minPointsScore[D][C][3]);k.l5+=b.l5+g.l5+y.l5,k.l4+=b.l4+g.l4+y.l4,k.d4+=b.d4+g.d4+y.d4,k.l3+=b.l3+g.l3+y.l3,k.d3+=b.d3+g.d3+y.d3,k.l2+=b.l2+g.l2+y.l2,k.d2+=b.d2+g.d2+y.d2,k.l1+=b.l1+g.l1+y.l1;const{l5:L,l4:_,d4:E,l3:N}=k;L?i.push(v):_?f.push(v):(N&&E&&c.push(v),E&&r.push(v)),M=ot(k)}p.push({position:[D,C],score:x*this.attackFactor+M*this.defenseFactor})}let w;if(e)return t?n.length?n:i.length?i:a.length?a:h.length?h:f.length||c.length?o.concat(u):o.concat(d).concat(u).concat(l):n.length?n:a.length||o.length?r.concat(a).concat(o).concat(u):p.sort((S,v)=>v.score-S.score).map(S=>S.position);if(t){if(n.length)return n;if(i.length)return i;if(a.length)return a;if(o.length&&!f.length&&!r.length)return o;if(!u.length&&f.length)return f.concat(r)}else{if(i.length)return i;if(n.length)return n;if(f.length)return f;if(c.length&&!a.length&&!u.length)return c;if(!r.length&&a.length)return a.concat(u)}return w=p.sort((S,v)=>v.score-S.score).map(S=>S.position),w.length<=this.genLimit?w:w.slice(0,this.genLimit)}const ce=st(1,2,3),he=st(2,1,3);class q{constructor(t){I(this,"genChilds",ue);I(this,"evaluate",le);I(this,"serialPointMode",W);this.init({...t})}init({firstHand:t,autoPlay:e,enableStats:n,attackFactor:i,defenseFactor:a}){this.node0=[],this.node1=[],this.node2=[],this.node3=[],this.initNode(),this.stack=[],this.zobrist=new ae({size:15}),this.maxPointsScore=F(15).map(()=>F(15,[0,0,0,0],!0)),this.minPointsScore=F(15).map(()=>F(15,[0,0,0,0],!0)),this.stats={},this.initStats(),this.enableStats=n!==void 0?n:!0,this.enableLog=!1,this.firstHand=t||2,this.genLimit=20,this.seekDepth=8,this.seekKillDepth=21,this.autoPlay=e||!1,this.attackFactor=i||1,this.defenseFactor=a||1,this.timeLimit=3e3}maxGo(){if(this.isFinal)return;console.log(Object.keys(this.zobrist.hash).length),this.initStats();const t=this.getMaxNextStep(),{i:e,j:n,score:i}=t;return this.put(e,n,1),this.logStats(),console.log({score:this.evaluate(),score2:i}),t}getMaxNextStep(){let t=this.genChilds(this.getAllOptimalNextStep(),!0);if(t=t.map(n=>({i:n[0],j:n[1]})),console.log({points:t}),t.length===1)return t[0];const e=this.seekKill();if(e)return e;this.startTime=+new Date,console.time("thinking");for(let n=2;n<=this.seekDepth&&(this.zobrist.resetHash(),!(+new Date-this.startTime>this.timeLimit));n+=2){for(let i=0;i<t.length;i++){let a=t[i];const{i:f,j:u}=a;this.put(f,u,1);const r=this.minimax(n-1,!1);this.rollback(),r.score!==-1/0&&(a.score=r.score,a.depth=n,a.stack=r.stack)}t=t.sort((i,a)=>a.score-i.score),console.log(n,t)}return console.timeEnd("thinking"),t[0]}seekKill(){if(this.stack.length>4){this.startTime=+new Date,console.time("thinking kill");for(let t=3;t<=this.seekKillDepth&&(this.zobrist.resetHash(),!(+new Date-this.startTime>this.timeLimit));t+=2){const e=this.minimax(t,!0,!0);if((e==null?void 0:e.score)>=m.win)return console.warn("算杀成功 :)",e),this.logStats(),console.timeEnd("thinking kill"),e}console.timeEnd("thinking kill")}}minGo(t,e){if(!this.isFinal)return this.isEmptyPosition(t,e)?(this.put(t,e,2),console.log({score:this.evaluate()}),!0):!1}minimax(t,e=!0,n=!1,i=-1/0,a=1/0){if(this.isFinal||t===0)return{score:this.evaluate(n),depth:t,stack:structuredClone(this.stack)};const f=this.genChilds(this.getAllOptimalNextStep(),e,n);if(e){if(f.length===0)return{score:-.1};let u=-1/0,r=f[0],l;for(const c of f){if(+new Date-this.startTime>this.timeLimit)break;const[d,p]=c;this.put(d,p,1),this.enableStats&&this.stats.abCut.eva++;let w=this.zobrist.get(),S;if(w===void 0){const v=this.minimax(t-1,!e,n,i,a);w=v.score,S=v.stack,this.zobrist.set(w),this.enableStats&&this.stats.zobrist.miss++}else this.enableStats&&this.stats.zobrist.hit++;if(this.rollback(),w>u&&(u=w,r=c,l=S),i=Math.max(i,u),a<=i){this.enableStats&&this.stats.abCut.cut++;break}}const[h,o]=r;return{score:u,i:h,j:o,stack:l}}else{if(f.length===0)return{score:.2};let u=1/0,r=f[0],l;for(const c of f){if(+new Date-this.startTime>this.timeLimit){u=-1/0;break}const[d,p]=c;this.put(d,p,2),this.enableStats&&this.stats.abCut.eva++;let w=this.zobrist.get(),S;if(w===void 0){const v=this.minimax(t-1,!e,n,i,a);w=v.score,S=v.stack,this.zobrist.set(w),this.enableStats&&this.stats.zobrist.miss++}else this.enableStats&&this.stats.zobrist.hit++;if(this.rollback(),w<u&&(u=w,r=c,l=S),a=Math.min(a,u),a<=i){this.enableStats&&this.stats.abCut.cut++;break}}const[h,o]=r;return{score:u,i:h,j:o,stack:l}}}isWall(t,e){return t<0||t>=15||e<0||e>=15}initNode(){this.node0=F(15,0),this.node1=F(15,0),this.node2=[];for(let t=0;t<15*2-1;t++){let e=0;for(let n=0;n<15;n++){const i=t-n;e<<=2,this.isWall(n,i)&&(e+=3)}this.node2[t]=e}this.node3=[];for(let t=0;t<15*2-1;t++){let e=0;for(let n=0;n<15;n++){const i=14+n-t;e<<=2,this.isWall(n,i)&&(e+=3)}this.node3[t]=e}}put(t,e,n){this.zobrist.go(t,e,n===1),this.stack.push([t,e]),this.node0[t]=this.node0[t]|n<<2*(14-e),this.node1[e]=this.node1[e]|n<<2*(14-t),this.node2[t+e]=this.node2[t+e]|n<<2*(14-t),this.node3[14+t-e]=this.node3[14+t-e]|n<<2*(14-t),this.updateFourLineScore(t,e)}rollback(t=1){if(!(this.stack.length<t))for(;t-- >0;){const[e,n]=this.stack.pop();this.zobrist.go(e,n,this.getChess(e,n)===1);const i=2*(14-n);this.node0[e]=(this.node0[e]|3<<i)^3<<i;const a=2*(14-e);this.node1[n]=(this.node1[n]|3<<a)^3<<a,this.node2[e+n]=(this.node2[e+n]|3<<a)^3<<a,this.node3[14+e-n]=(this.node3[14+e-n]|3<<a)^3<<a,this.updateFourLineScore(e,n)}}minRepent(){this.stack.length>=2&&this.rollback(2)}isEmptyPosition(t,e){return!this.isWall(t,e)&&this.getChess(t,e)===0}getNearPositions(t){const e=[],[i,a]=t;for(let f=-2;f<=2;f++)for(let u=-2;u<=2;u++)this.isEmptyPosition(f+i,u+a)&&e.push([f+i,u+a]);return e}getAllOptimalNextStep(){if(this.stack.length===0)return[[7,7]];if(this.stack.length===1){if(this.isEmptyPosition(7,7))return[[7,7]];const e=7+(Math.random()>.5?1:-1),n=7+(Math.random()>.5?1:-1);return[[e,n]]}let t=[];for(let e=0;e<15;e++)for(let n=0;n<15;n++)this.getChess(e,n)===0&&this.haveNeighbor(e,n)&&t.push([e,n]);return t}haveNeighbor(t,e){for(let i=-2;i<=2;i++)if(!(i+t<0||i+t>=15))for(let a=-2;a<=2;a++){if(a+e<0||a+e>=15||i===0&&a===0)continue;if(this.getChess(i+t,e+a)!==0)return!0}return!1}getChess(t,e){return this.node0[t]>>2*(14-e)&3}getChessInFourDirection(t,e,n){if(n===0){const i=this.node0[t],a=e>=4?i>>2*(18-e)&3:3,f=e>=3?i>>2*(17-e)&3:3,u=e>=2?i>>2*(16-e)&3:3,r=e>=1?i>>2*(15-e)&3:3,l=i>>2*(14-e)&3,h=e<=13?i>>2*(13-e)&3:3,o=e<=12?i>>2*(12-e)&3:3,c=e<=11?i>>2*(11-e)&3:3,d=e<=10?i>>2*(10-e)&3:3;return[a,f,u,r,l,h,o,c,d]}else{let i;n===1?i=this.node1[e]:n===2?i=this.node2[t+e]:n===3&&(i=this.node3[14+t-e]);const a=t>=4?i>>2*(18-t)&3:3,f=t>=3?i>>2*(17-t)&3:3,u=t>=2?i>>2*(16-t)&3:3,r=t>=1?i>>2*(15-t)&3:3,l=i>>2*(14-t)&3,h=t<=13?i>>2*(13-t)&3:3,o=t<=12?i>>2*(12-t)&3:3,c=t<=11?i>>2*(11-t)&3:3,d=t<=10?i>>2*(10-t)&3:3;return[a,f,u,r,l,h,o,c,d]}}getPositionsInFourDirection(t,e){let n=[],i=[],a=[],f=[];const u=t-4>0?t-4:0,r=t+4<15-1?t+4:15-1,l=e-4>0?e-4:0,h=e+4<15-1?e+4:15-1;for(let o=l;o<=h;o++)n.push([t,o]);for(let o=u;o<=r;o++)i.push([o,e]);for(let o=4;o>0;o--)t-o>=u&&e+o<=h&&a.push([t-o,e+o]);a.push([t,e]);for(let o=1;o<=4;o++)t+o<=r&&e-o>=l&&a.push([t+o,e-o]);for(let o=4;o>0;o--)t-o>=u&&e-o>=l&&f.push([t-o,e-o]);f.push([t,e]);for(let o=1;o<=4;o++)t+o<=r&&e+o<=h&&f.push([t+o,e+o]);return[n,i,a,f]}updateFourLineScore(t,e){const n=this.getPositionsInFourDirection(t,e);for(let i=0;i<4;i++){const a=n[i];for(let f=0;f<a.length;f++){const u=a[f];this.updatePointScore(u,i)}}}updatePointScore(t,e){const[n,i]=t;if(this.getChess(n,i)!==0)this.maxPointsScore[n][i]=[0,0,0,0],this.minPointsScore[n][i]=[0,0,0,0];else{const a=this.getChessInFourDirection(n,i,e);this.maxPointsScore[n][i][e]=W[ce(a)]||0,this.minPointsScore[n][i][e]=W[he(a)]||0}}saveStack(){console.log(JSON.stringify(this.stack))}restoreStack(t){const e=this.firstHand,n=e===1?2:1;this.rollback(this.stack.length);for(let i=0;i<t.length;i++){const[a,f]=t[i],u=i%2===0?e:n;this.put(a,f,u)}}test(t){console.log(Function(t).call(this))}get winner(){if(this.stack.length<7)return null;const[t,e]=this.stack[this.stack.length-1],n=this.getChess(t,e),i=[this.getChessInFourDirection(t,e,0),this.getChessInFourDirection(t,e,1),this.getChessInFourDirection(t,e,2),this.getChessInFourDirection(t,e,3)];for(let a=0;a<4;a++){let f=0;const u=i[a];for(let r=0;r<u.length;r++)if(u[r]===n?f++:f=0,f===5)return n}return null}get winnerPositions(){if(!this.winner)return null;const[t,e]=this.stack[this.stack.length-1],n=this.getChess(t,e),i=this.getPositionsInFourDirection(t,e);for(let a=0;a<4;a++){const f=i[a];let u=0,r=[];for(let l=0;l<f.length;l++){const[h,o]=f[l];if(this.getChess(h,o)===n?(u++,r.push([h,o])):(u=0,r=[]),u===5)return r}}return null}get isFinal(){return!!this.winner||this.isBoardFull}get isBoardFull(){return this.stack.length===15**2}get lastChessPosition(){return this.stack.length?this.stack[this.stack.length-1]:null}get isDraw(){return this.isBoardFull&&!this.winner}get node(){return this.node0.map(t=>{let e=[];for(let n=0;n<15;n++)e.push((t&3<<2*n)>>2*n);return e.reverse()})}printNode(){console.log(this.node0.map(t=>t.toString(2))),console.log(this.node1.map(t=>t.toString(2))),console.log(this.node2.map(t=>t.toString(2))),console.log(this.node3.map(t=>t.toString(2)))}initStats(){this.stats={abCut:{all:this.genLimit**this.seekDepth,eva:0,cut:0,toString(){const{all:t,eva:e,cut:n}=this.stats.abCut,i=t-e;return`AB剪枝 最大节点总数:${t} 理论最少评估${t**.5>>0} 实际评估:${e} 剪去:${n}/${i}`}},zobrist:{miss:0,hit:0,toString(){const{hit:t,miss:e}=this.stats.zobrist;return`zobrist 评估节点数:${this.stats.abCut.eva} hit:${t} miss:${e}`}}}}logStats(){this.enableStats&&Object.keys(this.stats).forEach(t=>{console.log(this.stats[t].toString.call(this))})}}I(q,"MAX",1),I(q,"MIN",2),I(q,"EMPTY",0),I(q,"WALL",3);let A=new q;onmessage=async function(s){const{type:t,data:e}=s.data;let n;switch(t){case"init":A.init(e),A.autoPlay&&fe();break;case"maxGo":n=A.maxGo();break;case"minGo":n=A.minGo(...e);break;case"minRepent":n=A.minRepent();break;case"reStart":n=A.init({});break;case"test":n=A.test(e);break}it(t,n)};const it=(s,t)=>postMessage({type:s,data:t,gobang:JSON.stringify({...A,node:A.node,stack:A.stack,firstHand:A.firstHand,lastChessPosition:A.lastChessPosition,winnerPositions:A.winnerPositions,isDraw:A.isDraw,winner:A.winner,isFinal:A.isFinal})}),fe=async()=>{const s=new q({firstHand:q.MIN,seekDepth:2,defenseFactor:4});A.genLimit=30,A.seekDepth=8,s.seekDepth=4,s.genLimit=60,s.defenseFactor=1;const t=async()=>{if(A.isFinal)return;const{i,j:a}=A.maxGo();s.minGo(i,a),it("autoPlay")},e=async()=>{if(A.isFinal)return;const{i,j:a}=s.maxGo();A.minGo(i,a),it("autoPlay")},n=500;for(;A.autoPlay&&!A.isFinal;)await t(),await at(n),await e(),await at(n)}})();
